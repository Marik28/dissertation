# Диаграммы классов программы

## Протоколы, шины, периферия

```mermaid
classDiagram
    class BaseDevice {
        <<abstract>>
        +int min_code
        +int max_code
        +send_code(int code)
        validate_code(int code)
    }
    
    class AD8400 {
        -SPIDevice spidev
        send_code(int code)
    }
    
    class MCP4725 {
        -_MCP4725 mcp 
        -int address
        send_code(int code)
    }
    
    class BaseRelay {
    <<interface>>
        +turn_on()
        +turn_off()
        +set_value(bool value)
    }
    
    class DigitalIORelay {
        -DigitalInOut pin
        -float delay
        +set_value(bool value)
    }
    
    class I2C {
        Pin scl
        Pin sda
        int frequency
        scan() list~int~
        writeto(int address, bytes buffer, start, end, stop)
    }
    
    class SPI {
        Pin clock
        Pin MOSI
        Pin MISO
        configure(int baudrate, int polarity, int phase, int bits)
        write(bytes buf, int start, int end)
    }
    
    class SPIDevice{
        +SPI spi
        +int baudrate
        +int polarity
        +int phase
        +int extra_clocks
        +DigitalInOut chip_select
        +bool cs_active_value
        __enter__() SPI
        __exit__() bool
    }

    class _MCP4725 {
        +int value
        +int raw_value
        -int address
        -I2C i2c
    }
    
    class DigitalInOut {
        -Pin pin
        +Direction direction
        +bool value
        +switch_to_output()
        +switch_to_input()
    } 
    
    class Direction {
        <<enumeration>>
        INPUT
        OUTPUT
    }
    
    class Pin {
        int id
    }
   
    class Lockable {
        -bool locked 
        +try_lock() bool
        +unlock() 
    }
    
    class ContextManaged {
        __enter__() 
        __exit__()
        deinit() 
    }
   
    _MCP4725 o-- I2C
    Lockable <|-- I2C
    Lockable <|-- SPI
    ContextManaged <|-- Lockable
    BaseDevice <|-- AD8400
    BaseDevice <|-- MCP4725
    DigitalInOut <-- Direction 
    AD8400 *-- SPIDevice
    SPIDevice o-- SPI
    SPIDevice *-- DigitalInOut
    ContextManaged <|-- DigitalInOut
    MCP4725 *-- _MCP4725
    BaseRelay <|.. DigitalIORelay
    DigitalIORelay o-- DigitalInOut
    I2C o-- Pin
    SPI o-- Pin
    DigitalInOut o-- Pin
```

Дополнение к периферии

```mermaid
classDiagram

    Lockable <|-- I2C
    Lockable <|-- SPI
    ContextManaged <|-- Lockable
    ContextManaged <|-- DigitalInOut
    
    class Lockable {
        -bool locked 
        +try_lock() 
        bool +unlock() 
    }
    
    class ContextManaged {
        __enter__() 
        __exit__()
        deinit() 
    }
```

## Управление симуляторами датчиков

```mermaid
classDiagram

    class SensorWorker {
        -dict~SensorType, BaseSensorManager~ managers 
        -BaseSensorManager current_manager 
        set_temperature(Number temperature)
        set_sensor(Sensor sensor)
    }
    
    class QObject {
        moveToThread(QThread thread)
    }
    
    class BaseSensorManager {
        <<interface>>
        +set_sensor(Sensor sensor)
        +set_temperature(Number temperature)
        +select()
        +unselect()   
    }
    
    class UnifiedAnalogSignalManager {
        -int min_temperature 
        -int max_temperature
        -MCP4725 mcp4725 
        -list~BaseRelay~ relays
        set_max_temperature(int new_temperature)
        set_min_temperature(int new_temperature)
        set_sensor(Sensor sensor)
        set_temperature(Number temperature)
        select()
    }
    
    class ResistanceThermometerManager {
        -list~AD8400~ digipots
        -list~BaseRelay~ relays
        -DataFrame df
        -calculate_codes(Number temperature)
        set_sensor(Sensor sensor)
        set_temperature(Number temperature)
        select()
    }
    class ThermocoupleManager {
        -MCP4725 dac
        -list~BaseRelay~ relays
        -DataFrame df
        set_sensor(Sensor sensor)
        set_temperature(Number temperature)
        select()
    }
  
    QObject <|-- SensorWorker
    QThread o-- SensorWorker
    SensorWorker o-- BaseSensorManager
    BaseSensorManager <|.. UnifiedAnalogSignalManager
    BaseSensorManager <|.. ResistanceThermometerManager
    BaseSensorManager <|.. ThermocoupleManager
    ResistanceThermometerManager o-- BaseRelay
    ResistanceThermometerManager *-- DataFrame
    ThermocoupleManager *-- DataFrame
    ThermocoupleManager o-- MCP4725
    ThermocoupleManager o-- BaseRelay
    UnifiedAnalogSignalManager o-- MCP4725
    UnifiedAnalogSignalManager o-- BaseRelay
    ResistanceThermometerManager o-- AD8400
```

## Протокол Овен

```mermaid
classDiagram
    
    class OwenClient {
        -Serial serial
        -int address
        -int address_length
        get_parameter(str name, ParamType type_, int index)
    }
    
    class Serial {
        +baudrate
        +port
        +timeout
        open()
        close()
        write(bytearray data) int
        read_until(bytes expected, int size) bytes
    }
    
    class ParamType {
        <<enumeration>>
        SIGNED_CHAR
        UNSIGNED_CHAR
        SHORT
        UNSIGNED_SHORT
        FLOAT24
        FLOAT
        STRING
        NERR        
    }
    
    class TRMParametersReadThread {
        pyqtSignal~list~ parameters_signal
        OwenClient client
        float update_period
        run()
    }
    
    class QThread {
        run()
        sleep(int a0)
        msleep(int a0)
        start(priority)
    }
    
    OwenClient *-- Serial
    QThread <|-- TRMParametersReadThread
    TRMParametersReadThread o-- OwenClient 
```

## Графики, расчёты

```mermaid
classDiagram
    
    class Solver {
        <<abstract>>
        float k
        float start_temperature
        float temperature
        float set_temperature
        float interference_amplitude
        float interference_frequency
        float direction
        bool sinusoidal_interference_enabled
        bool burst_interference_enabled
        set_sinusoidal_interference_enabled(bool value)
        set_burst_interference_enabled(bool value)
        set_set_temperature(float temperature)
        set_interference_amplitude(float amplitude)
        set_interference_frequency(float frequency)
        calculate_temperature(float time) float
        calculate_burst_interference(float time) float
        calculate_sinusoidal_interference(float time) float
    }
    
    class LinearSolver {
        calculate_temperature(float time) float
    }
    class ControlLogic {
        <<abstract>>
    }
    class TemperatureCalculationThread {
        pyqtSignal~float~ temperature_signal
        Solver solver
        float update_period
        float
        bool reset
        run()
        set_k_ratio(float k)
        now()
        set_temperature(float new_set_temperature)
    }
    
    
    QThread <|-- TemperatureCalculationThread
    TemperatureCalculationThread o-- Solver
    Solver <|-- LinearSolver
    ControlLogic <|-- ReversedControlLogic
    ControlLogic <|-- DirectControlLogic
    ControlLogic <|-- PShapedControlLogic
    ControlLogic <|-- UShapedControlLogic
```

## Взаимодействие с БД

```mermaid
classDiagram

    class SensorCharacteristics {
        int id
        int temperature
        int value
        Sensor sensor
    }
    
    class SensorsService {
        -Session session
        get_sensors() list~Sensor~
    }
    
    class SensorCharacteristicsService {
        -Session session
        get_characteristics_by_sensor_name(str sensor) list~SensorCharacteristics~
    }

    class Sensor {
        int id
        str name
        SensorType type
        int min_temperature
        int max_temperature
        str units
        str physical_quantity
        str trm_code
        int int_code
    }
    
    class SensorType {
        <<enumeration>>
        RESISTANCE_THERMOMETER
        THERMO_COUPLE
        UNIFIED_ANALOG_SIGNAL
    }

    class Session {
        query()
        commit()
        close()
    }

    SensorsService o-- Session
    SensorCharacteristics -- Sensor
    SensorsService -- Sensor
    Sensor -- SensorType
    SensorCharacteristicsService -- SensorCharacteristics
    SensorCharacteristicsService o-- Session
```

## Интерфейс

```mermaid
classDiagram

    class SensorsComboBox {
        pyqtSignal~Sensor~ sensor_changed
        -list~Sensor~ sensors
        set_sensors(list~Sensor~)
        on_text_changed(str text)
    }
    
    class CharacteristicsTableWidget {
        SensorCharacteristicsService service
        display_characteristics(Sensor sensor)
    }
    
    class TRMParametersInfoTable {
        update_info(list~dict~ parameters)
    }
    
    class SensorInfoTable{
        update_info(Sensor sensor)
    }
    
    class QAbstractSpinBox {
        pyqtSignal~int~ valueChanged
    }
    
    class QApplication {
        exec() int
    }
    
    class QWidget {
        show()
        hide()
    }

    class QSpinBox {
        int maximum
        int minimum
        setMaximum(int max)
        setMinimum(int min)
    }
    
    class QTableWidget {
        setColumnCount(int columns)
        setRowCount(int rows)
        setVerticalHeaderLabels(Iterable~str~ labels)
        setHorizontalHeaderLabels(Iterable~str~ labels)
        setItem(int row, int column, QTableWidgetItem item)
        resizeColumnsToContents()
        resizeRowsToContents()
    }
    
    class QDoubleSpinBox {
        pyqtSignal~float~ valueChanged
    } 
    
    class QCheckBox {
        pyqtSignal~int~ stateChanged
    }
    
    class QComboBox {
        pyqtSignal~str~ currentTextChanged
        addItems(Iterable~str~)
        setCurrentText(~str~)
    }
    
        class CurveManager {
        -PlotDataItem curve
        -deque~float~ values
        -deque~float~ times
        update(float time, float value)
    }
    
    class TemperaturePlotManager {
        -PlotWidget plot_widget
        -int max_points
        -float start_time
        -CurveManager setpoint_curve
        -CurveManager measured_temp_curve
        -CurveManager set_temp_curve
        update_setpoint_curve()       
        update_measured_temp_curve()       
        update_set_temp_curve()       
    }
    
    class PlotWidget {
        clear()
        plot(*args, **kwargs) PlotDataItem
    }
    
    class PlotDataItem {
        setData(*args, **kwargs)
    }

    
    QObject <|-- QApplication 
    QObject <|-- QWidget
    QWidget <|-- QAbstractSpinBox
    QWidget <|-- QCheckBox
    QWidget <|-- QTableWidget
    QWidget <|-- QComboBox
    QComboBox <|-- SensorsComboBox
    QTableWidget <|-- CharacteristicsTableWidget
    QTableWidget <|-- SensorInfoTable
    QTableWidget <|-- TRMParametersInfoTable
    QAbstractSpinBox <|-- QDoubleSpinBox
    QAbstractSpinBox <|-- QSpinBox
    QWidget <|-- PlotWidget
    TemperaturePlotManager o-- PlotWidget
    TemperaturePlotManager *-- CurveManager
    CurveManager o-- PlotDataItem
```
