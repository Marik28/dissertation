# Алгоритм работы программы

```mermaid
flowchart
    Start(["Начало программы"]) --> A0
    subgraph "Инициализация"
        A0["Открытие соединения с БД"] --> A1
        A1["Чтение списка датчиков из БД"] --> A2
        A2["Инициализация шины SPI"] --> A3
        A3["Инициализация шины I2C"] --> A4
        A4["Инициализация последовательного порта"] --> A5
        A5["Инициализация GPIO портов"] --> A6
        A6["Создание потоков для 
        параллельного выполнения программы"] --> A7
    end
    A7["Инициализация интерфейса"] --> B1
    B1[/"Задание скорости изменения температуры"/] --> B2
    B2[/"Задание температуры окружающей среды"/] --> B3
    B3[/"Задание режима помех"/] --> B
    B[/"Выбор датчика для симуляции из списка"/] --> C1
    C1{"Выбранный датчик 
    - термопара?"} -->|"Да"| C2
    C2["Переключение реле в режим 
    симуляции термопары"] --> C6
    C6["Выбор модуля управления ЦАП"] --> C8
    C1 -->|"Нет"| C3
    C3{"Выбранный датчик -
    термометр 
    сопротивления?"} -->|"Да"| C4
    C3 -->|"Нет"| C5
    C5["Переключение реле в режим 
    симуляции датчика УАС"] --> C6
    C4["Переключение реле в режим 
    симуляции термометра сопротивления"] --> C7
    C7["Выбор модуля управления 
    цифровыми резисторами"] --> C8
    C8["Чтение характеристики датчика из базы данных"] --> C
    C["Отображение характеристики датчика"] --> F
    F["Расчет текущей температуры"] --> G
    G["Расчет кода для отправки модулю отправления"] --> G1
    G1{"Выбран модуль 
    управления ЦАП?"} -->|"Да"| G2
    G1 -->|"Нет"| G3
    G2["Отправка данных ЦАП по шине I2C"] --> H
    G3["Отправка данных цифровым 
    резисторам по шине SPI"] --> H
    H["Чтение параметров ТРМ по протоколу Овен"] --> I1
    I1["Отображение считанных параметров ТРМ"] --> I2
    I2["Перерисовка графика изменения температуры"] --> J
    J{"Пользователь закрыл 
    программу?"} -->|"Да"| K1
    J -->|"Нет"| L
    L{"Пользователь выбрал 
    другой датчик 
    для симуляции?"} -->|"Да"| C1
    L -->|"Нет"| F
    subgraph "Деинициализация"
        K1["Закрытие соединения с БД"] --> K2
        K2["Закрытие последовательного порта"] --> K3
        K3["Деинициализация GPIO портов"] --> K4
        K4["Деинициализация шины SPI"] --> K5
        K5["Деинициализация шины I2C"] --> K6
    end
    K6["Остановка и удаление потоков"] --> End
    End(["Завершение программы"])
```

# Упрощенный алгоритм взаимодействия пользователя с программой

```mermaid
flowchart
    Start(["Запуск программы"]) --> A
    A["Инициализация модулей программы,
    инициализация шин протоколов,
    чтение данных из БД"] --> B1
    B1["Отображение интерфейса - графиков, 
    таблиц, меню выборов параметров"] --> B2 
    B2[/"Пользователь выбирает заданную температуру, 
    режим помех, датчик для симуляции"/] --> C
    C["Отображание характеристики датчика"] --> D
    D["Переключение реле, выбор 
    соответствующего модуля управления"] --> E
    E["Расчет температуры"] --> F
    F["Расчет кода для отправки модулю управления"]  --> G
    G["Отправка кода устройству, симулирующему датчик"] --> H
    H["Чтение параметров ТРМ"] --> I
    I["Отображение параметров ТРМ"] --> J
    J["Перерисовка графика изменения температуры"] --> K
    K{"Пользователь закрыл 
    программу?"} -->|"Нет"| E
    K -->|"Да"| Z     
    Z["Деинициализация модулей программы,
    деинициализация шин протоколов,
    закрытие соединения с БД"] --> End
    End(["Завершение программы"])
```

# Алгоритм расчета таблицы для симуляции термометра сопротивления

```mermaid
flowchart
    Start(["Начало"]) --> A
    A["Получить характеристику датчика sensor_characteristics, 
    диапазон симулируемых температур simulation_range,
    характеристики цифровых резисторов digipot1_data, digipot2_data"] --> B
    B["Инициализировать словарь possible_values = {}"] --> C1
    C1{"digipot1_data имеет 
    оставшиеся значения?"} -->|"Да"| D1
    D1["Получить следующее значение для r1 из digipot1_data"] --> D2
    C1 --> |"Нет"| G
    D2{"digipot2_data имеет 
    оставшиеся значения?"} -->|"Да"| E1
    E1["Получить следующее значение для r2 из digipot2_data"] --> E2
    D2 -->|"Нет"| C1
    E2["Рассчитать possible_value = round((r1['resistance'] * r2['resistance']) / (r1['resistance'] + r2['resistance']), 5)"] --> E3
    E3["Рассчитать массив codes = [int(r1['code']), int(r2['code'])]"] --> F
    F["Добавить массив codes в possible_values по ключу possible_value"] --> D2
    G["min_temp, max_temp = simulation_range"] --> H
    H["Получить значение min_value по индексу min_temp из sensor_characteristics по ключу 'value'"] --> I
    I["Получить значение max_value по индексу max_temp из sensor_characteristics по ключу 'value'"] --> J
    J["Инициализировать массив simulated_values"] --> J1
    J1{"ключи possible_values содержит 
    оставшиеся значения?"} -->|"Да"| J2
    J1 --> |"Нет"| J10
    J2["Получить следующее значение для
     value из ключей possible_values"] --> J3
    J3{"value больше min_value 
    и меньше max_value?"} -->|"Да"| J4
    J3 -->|"Нет"| J1
    J4["Добавить value в массив simulated_values"] --> J1
    J10["Инициализировать датафрейм df = pd.DataFrame()"] --> K1
    K1["Инициализировать последовательность range_1 
    от min_temp до max_temp включительно"] --> K2
    K2{"sensor_characteristics имеет 
    оставшиеся значения?"} -->|"Да"| K3
    K2 -->|"Нет"| L
    K3["Получить следующее значение для row из sensor_characteristics"] --> K4
    K4{"range_1 содержит 
    row.index?"} -->|"Да"| K5
    K4 -->|"Нет"| K2
    K5["Добавить row['value'] в столбец df['R']"] --> K2
    L{"Столбец df['R'] содержит 
    оставшиеся значения?"} -->|"Да"| L2
    L -->|"Нет"| M
    L2["Получить следующее значение для x из столбца df['R']"] --> L3
    L3[["Рассчитать r = find_nearest(simulation_range, x)"]] --> L4
    L4["Добавить r в столбец df['calc']"] --> L
    M{"Столбец df['calc'] имеет
     оставшиеся значения?"} -->|"Да"| M1
    M --> |"Нет"| Q
    M1["Получить следующее значение для x из столбца df['calc']"] --> M2
    M2["Получить значение codes по ключу x из словаря possible_values"] --> M3
    M3["Добавить значение x[0] в стоблец df['R1_code']"] --> M4
    M4["Добавить значение x[1] в стоблец df['R2_code']"] --> M
    Q{"Столбец df['R1_code'] имеет 
    оставшиеся значения?"} -->|"Да"| Q1
    Q -->|"Нет"| R
    Q1["Получить следующее значение для code 
    из столбца df['R1_code']"]--> Q2
    Q2["Получить значение r из столбца digipot1_data['code'] по значению code"] --> Q3
    Q3["Добавить r в столбец df['R1']"] --> Q
    R{"Столбец df['R2_code'] имеет 
    оставшиеся значения?"} -->|"Да"| R1
    R -->|"Нет"| S
    R1["Получить следующее значение для code 
    из столбца df['R2_code']"]--> R2
    R2["Получить значение r из столбца digipot2_data['code'] по значению code"] --> R3
    R3["Добавить r в столбец df['R2']"] --> Q
    S["Удалить столбец df['codes']"] --> End
    End(["Вернуть датафрейм df"])
```

# Алгоритм расчета таблицы для симуляции термопары

```mermaid
flowchart
    Start(["Начало"]) --> A
    A["Получить на вход характеристику датчика sensor_characteristic, 
    диапазон симулируемых температур simulation_range, характеристику ЦАП mcp_data"] --> B
    B["min_temp, max_temp = simulation_range"] --> C
    C["Инициализировать датафрейм df"] --> D
    D["Рассчитать промежуточный диапазон range_1 = range(min_temp, max_temp + 1)"] --> E
    E["Рассчитать срез датафрейма sensors_characteristics_1 = sensor_characteristics.index.isin(range_1)"] --> F
    F["Записать столбец df['voltage'] = sensors_characteristics_1['value']"]  --> G 
    G["Записать столбец df['calc'] = df['voltage'].apply(lambda x: int(math.copysign(1, x)) * find_nearest(mcp_data['divided_voltage (mV)'], abs(x)),)"] --> H
    H["df['error'] = abs(df['voltage'] - df['calc'])"] --> I
    I["df['code'] = df['calc'].apply(lambda x: int(mcp_data[mcp_data['divided_voltage (mV)'] == abs(x)].iloc[0]['code']))"] --> J
    J["return df"] --> End
    End(["Конец"])
```

# Алгоритм нахождения ближайшего значения к `value` в массиве `values`

```mermaid
flowchart
    Start(["Начало"]) --> A
    A["Получить на вход итерируемый объект values, значение value"] --> B1
    B1["Инициализировать массив array"] --> B2
    B2{"values содержит 
    оставшиеся значения?"} -->|"Да"| B3
    B2 -->|"нет"| C
    B3["Получить следующее значение для v из values"] --> B4
    B4["Добавить v в массив array"] --> B2
    C["Инициализировать массив array1"] --> C1
    C1{"Массив array содержит
     оставшиеся значения?"} -->|"Да"| C2
    C1 --> |"Нет"| D
    C2["Получить следующее 
    значение для i из array"] --> C3
    C3["Добавить в array1 модуль значения (i - value)"] --> C1
    D[["Найти индекс минимального числа i = array1.argmin()"]] --> F
    F["Вернуть i-ый элемент массива array"] --> End
    End(["Конец"])
```