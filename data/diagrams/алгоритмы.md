# Алгоритм работы программы

```mermaid
flowchart
    Start(["Начало программы"]) --> A0
    subgraph "Инициализация"
        A0["Открытие соединения с БД"] --> A1
        A1["Чтение списка датчиков из БД"] --> A2
        A2["Инициализация шины SPI"] --> A3
        A3["Инициализация шины I2C"] --> A4
        A4["Инициализация последовательного порта"] --> A5
        A5["Инициализация GPIO портов"] --> A6
        A6["Создание потоков для 
        параллельного выполнения программы"] --> A7
    end
    A7["Инициализация интерфейса"] --> B1
    B1[/"Задание скорости изменения температуры"/] --> B2
    B2[/"Задание температуры окружающей среды"/] --> B3
    B3[/"Задание режима помех"/] --> B
    B[/"Выбор датчика для симуляции из списка"/] --> C1
    C1{"Выбранный датчик 
    - термопара?"} -->|"Да"| C2
    C2["Переключение реле в режим 
    симуляции термопары"] --> C6
    C6["Выбор модуля управления ЦАП"] --> C8
    C1 -->|"Нет"| C3
    C3{"Выбранный датчик -
    термометр 
    сопротивления?"} -->|"Да"| C4
    C3 -->|"Нет"| C5
    C5["Переключение реле в режим 
    симуляции датчика УАС"] --> C6
    C4["Переключение реле в режим 
    симуляции термометра сопротивления"] --> C7
    C7["Выбор модуля управления 
    цифровыми резисторами"] --> C8
    C8["Чтение характеристики датчика из базы данных"] --> C
    C["Отображение характеристики датчика"] --> F
    F["Расчет текущей температуры"] --> G
    G["Расчет кода для отправки модулю отправления"] --> G1
    G1{"Выбран модуль 
    управления ЦАП?"} -->|"Да"| G2
    G1 -->|"Нет"| G3
    G2["Отправка данных ЦАП по шине I2C"] --> H
    G3["Отправка данных цифровым 
    резисторам по шине SPI"] --> H
    H["Чтение параметров ТРМ по протоколу Овен"] --> I1
    I1["Отображение считанных параметров ТРМ"] --> I2
    I2["Перерисовка графика изменения температуры"] --> J
    J{"Пользователь закрыл 
    программу?"} -->|"Да"| K1
    J -->|"Нет"| L
    L{"Пользователь выбрал 
    другой датчик 
    для симуляции?"} -->|"Да"| C1
    L -->|"Нет"| F
    subgraph "Деинициализация"
        K1["Закрытие соединения с БД"] --> K2
        K2["Закрытие последовательного порта"] --> K3
        K3["Деинициализация GPIO портов"] --> K4
        K4["Деинициализация шины SPI"] --> K5
        K5["Деинициализация шины I2C"] --> K6
    end
    K6["Остановка и удаление потоков"] --> End
    End(["Завершение программы"])
```

# Упрощенный алгоритм взаимодействия пользователя с программой

```mermaid
flowchart
    Start(["Запуск программы"]) --> A
    A["Инициализация модулей программы,
    инициализация шин протоколов,
    чтение данных из БД"] --> B1
    B1["Отображение интерфейса - графиков, 
    таблиц, меню выборов параметров"] --> B2 
    B2[/"Пользователь выбирает заданную температуру, 
    режим помех, датчик для симуляции"/] --> C
    C["Отображание характеристики датчика"] --> D
    D["Переключение реле, выбор 
    соответствующего модуля управления"] --> E
    E["Расчет температуры"] --> F
    F["Расчет кода для отправки модулю управления"]  --> G
    G["Отправка кода устройству, симулирующему датчик"] --> H
    H["Чтение параметров ТРМ"] --> I
    I["Отображение параметров ТРМ"] --> J
    J["Перерисовка графика изменения температуры"] --> K
    K{"Пользователь закрыл 
    программу?"} -->|"Нет"| E
    K -->|"Да"| Z     
    Z["Деинициализация модулей программы,
    деинициализация шин протоколов,
    закрытие соединения с БД"] --> End
    End(["Завершение программы"])
```

## Алгоритм расчета таблицы для симуляции термометра сопротивления

```mermaid
flowchart
    Start(["Начало"]) --> A
    A["Передать sensor_characteristics, simulation_range,
     digipot1_data, digipot2_data"] --> B
    B["Инициализировать словарь possible_values = {}"] --> C
    C{"r1 - последний элемент 
    digipot1_data?"} -->|"Нет"| D
    C --> |"Да"| G
    D{"r2 - последний элемент 
    digipot2_data?"} -->|"Нет"| E
    D -->|"Да"| C
    E["possible_value = round((r1['resistance'] * r2['resistance']) / (r1['resistance'] + r2['resistance']), 5)"] --> F
    F["possible_values[possible_value] = [int(r1['code']), int(r2['code'])]"] --> D
    G["min_temp, max_temp = simulation_range"] --> H
    H["min_value = sensor_characteristics.loc[min_temp]['value']"] --> I
    I["max_value = sensor_characteristics.loc[max_temp]['value']"] --> J
    J["Инициализировать датафрейм df = pd.DataFrame()"] --> K
    K["df['R'] = sensor_characteristics[sensor_characteristics.index.isin(range(min_temp, max_temp + 1))]['value']"] --> L
    L["df['calc'] = df['R'].apply(lambda x: find_nearest(_simulation_range, x))"] --> M
    M["df['error'] = abs(df['R'] - df['calc'])"] --> N
    N["df['code'] = df['calc'].apply(lambda x: possible_values[x])"] --> O
    O["df['R1_code'] = df['code'].apply(lambda x: x[0])"] --> P
    P["df['R2_code'] = df['code'].apply(lambda x: x[1])"] --> Q
    Q["df['R1'] = df['R1_code'].apply(lambda x: digipot1_data[digipot1_data['code'] == x].iloc[0]['resistance'])"] --> R
    R["df['R2'] = df['R2_code'].apply(lambda x: digipot2_data[digipot2_data['code'] == x].iloc[0]['resistance'])"] --> S
    S["del df['code']"] --> End
    End([return df])
```

## Алгоритм нахождения ближайшего значения к `value` в массиве `values`

```mermaid
flowchart
    Start(["Начало"]) --> A
    A["Получить на вход values, value"] --> B
    B["array = np.asarray(values)"] --> C
    C["Рассчитать массив array1 = array - value"] --> D
    D["Рассчитать массив array2 = np.abs(array1)"] --> E
    E["Найти индекс минимального числа idx = array2.argmin()"] --> F
    F["return array[idx]"] --> End
    End(["Конец"])
```